# ADR 0004: Стратегія стійкості (Resilience) та обробка збоїв

**Дата:** 25 грудня 2025 року  
**Статус:** Прийнято  
**Контекст:** Проєкт потребує захисту від мережевих затримок, перевантаження сервера та дублювання даних при повторних запитах.

## 1. Проблема
При високому навантаженні або нестабільній мережі:
- Користувачі можуть надсилати однакові дані кілька разів (дублікати в БД).
- Сервер може тимчасово не відповідати (помилки 5xx).
- Запити можуть "зависати", блокуючи ресурси браузера.

## 2. Прийняті рішення

### 2.1. Ідемпотентність (Idempotency)
Для операцій створення (`POST`) впроваджено заголовок `Idempotency-Key`. 
- **Реалізація:** На сервері використовується `IMemoryCache` для збереження ключів протягом 24 годин.
- **Результат:** Повторні запити з тим самим ключем не призводять до створення дублікатів у базі даних.

### 2.2. Повторні спроби (Retries) з Exponential Backoff
Клієнтський код реалізує логіку повторних запитів.
- **Алгоритм:** Якщо сервер повертає 5xx або 429, запит повторюється до 3 разів.
- **Backoff:** Затримка між спробами зростає експоненційно (500мс -> 1000мс -> 2000мс).

### 2.3. Таймаути (Timeouts)
Встановлено жорсткий ліміт часу на виконання запиту — **1 секунда**.
- **Інструмент:** `AbortController` у JavaScript fetch та `CancellationTokenSource` на сервері (`/health`).

### 2.4. Режим деградації (Degraded Mode)
При вичерпанні ліміту спроб або таймауті інтерфейс переходить у стан деградації:
- Користувачу відображається банер "Сервер перевантажений".
- Кнопка відправки форми блокується (`disabled`), щоб запобігти подальшому лавиноподібному навантаженню.

## 3. Наслідки
- **Плюси:** Підвищена надійність системи, захист цілісності даних, покращений UX при збоях.
- **Мінуси:** Додаткове навантаження на пам'ять сервера (кеш ключів) та складніша логіка фронтенду.
