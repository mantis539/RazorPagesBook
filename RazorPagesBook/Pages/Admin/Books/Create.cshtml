@page
@model RazorPagesBook.Pages.Admin.Books.CreateModel

@{
    ViewData["Title"] = "Create";
}

<h1>Create</h1>
<h4>Book</h4>
<hr />

<div class="row">
    <div class="col-md-6">
        @* Об'єднана форма з ID та enctype для файлів *@
        <form id="createBookForm" method="post" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            @* Ключ ідемпотентності *@
            <input type="hidden" id="IdempotencyKey" name="IdempotencyKey" value="@Guid.NewGuid()" />

            <div class="form-group mb-3">
                <label asp-for="Book.Title" class="control-label"></label>
                <input asp-for="Book.Title" class="form-control" />
                <span asp-validation-for="Book.Title" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Book.Author" class="control-label"></label>
                <input asp-for="Book.Author" class="form-control" />
                <span asp-validation-for="Book.Author" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Book.Genre" class="control-label"></label>
                <input asp-for="Book.Genre" class="form-control" />
                <span asp-validation-for="Book.Genre" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Book.Price" class="control-label"></label>
                <input asp-for="Book.Price" class="form-control" />
                <span asp-validation-for="Book.Price" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Book.Rating" class="control-label"></label>
                <input asp-for="Book.Rating" class="form-control" />
                <span asp-validation-for="Book.Rating" class="text-danger"></span>
            </div>

            <div class="form-group mb-4">
                <label class="form-label fw-bold">Обкладинка (jpg/png/webp, до 2 МБ)</label>
                <input asp-for="CoverFile" type="file" class="form-control" accept=".jpg,.jpeg,.png,.webp" />
                <span class="text-danger" asp-validation-for="CoverFile"></span>
            </div>

            <div class="form-group">
                @* ID кнопки для JS *@
                <button type="submit" id="submitBtn" class="btn btn-primary">Create</button>
                <a asp-page="Index" class="btn btn-outline-secondary ms-2">Back to List</a>
            </div>
        </form>

        @* Банер перевантаження *@
        <div id="overloadBanner" class="alert alert-danger" style="display:none; margin-top:20px;">
            Сервер перевантажений (Timeout). Спробуйте ще раз через кілька секунд.
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.getElementById('createBookForm').addEventListener('submit', async function (e) {
            if (!$(this).valid()) return;

            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            const banner = document.getElementById('overloadBanner');
            const formData = new FormData(this);

            btn.disabled = true;
            banner.style.display = 'none';

            async function sendRequest(retries = 3, delay = 500) {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 1000); // Таймаут 1с за завданням

                try {
                    // Додаємо Anti-Forgery Token (потрібен для Razor Pages POST запитів через fetch)
                    const verificationToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

                    const response = await fetch(window.location.href, {
                        method: 'POST',
                        body: formData,
                        signal: controller.signal,
                        headers: {
                            'X-Request-Id': crypto.randomUUID(),
                            'Idempotency-Key': document.getElementById('IdempotencyKey').value,
                            'RequestVerificationToken': verificationToken
                        }
                    });

                    clearTimeout(timeout);

                    if (response.ok) {
                        // Якщо сервер повернув редірект або успіх
                        window.location.href = '@Url.Page("Index")';
                        return;
                    }

                    // Обробка 429 (Rate Limit) або 5xx (Server Error)
                    if (response.status === 429 || (response.status >= 500 && retries > 0)) {
                        const retryAfter = response.headers.get('Retry-After') || delay / 1000;
                        console.warn(`Помилка ${response.status}. Ретрай через ${retryAfter}с...`);
                        await new Promise(r => setTimeout(r, retryAfter * 1000));
                        return sendRequest(retries - 1, delay * 2);
                    }

                    throw new Error("Помилка сервера");

                } catch (err) {
                    if (err.name === 'AbortError' || retries === 0) {
                        banner.style.display = 'block';
                        btn.disabled = false; // Дозволяємо спробувати пізніше
                        console.error("Degraded mode activated: Timeout or Max retries reached");
                    } else {
                        await new Promise(r => setTimeout(r, delay));
                        return sendRequest(retries - 1, delay * 2);
                    }
                }
            }

            await sendRequest();
        });
    </script>
}